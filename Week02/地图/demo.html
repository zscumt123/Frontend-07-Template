<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .container {
            display: flex;
            flex-wrap: wrap;
            width:1000px;

        }

        .cell {
            width: 20px;
            height: 20px;
            box-sizing: border-box;
            border: 1px solid #ffffff;
            background-color: #cccccc;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container"></div>
    <button class="btn">保存</button>
    <script>
        let isPress = false
        let clear = false
        document.addEventListener('mousedown', (e) => {
            isPress = true
            clear = e.which === 3
        })
        document.addEventListener('mouseup', () => {
            isPress = false
        })
        document.addEventListener('contextmenu', e => {
            e.preventDefault()
        })
        const container = document.querySelector('.container')
        let mapStr = window.localStorage.getItem('map')
        let mapArr = mapStr ? JSON.parse(mapStr): Array(2500).fill(0)
        for (let i = 0; i < 50; i++) {
            for (let j = 0; j < 50; j++) {
                let cell = document.createElement('div')
                cell.classList.add('cell')
                if (mapArr[50 * i + j] === 1) {
                    cell.style.backgroundColor = '#000000'
                }
                cell.addEventListener('mousemove', (e) => {
                    if (isPress) {
                        if (clear) {
                            e.target.style.backgroundColor = '#cccccc'
                            mapArr[50 * i + j] = 0
                        } else {
                            e.target.style.backgroundColor = '#000000'
                            mapArr[50 * i + j] = 1
                        }
                    }
                }, false)
                container.append(cell)
            }
        }

        document.querySelector('.btn').addEventListener('click', () => {
            window.localStorage.setItem('map', JSON.stringify(mapArr))
        })

        function sleep(t) {
            return new Promise(resolve => {
                setTimeout(resolve, t)
            })
        }


        class Sorter {
            constructor(arr, compare) {
                this.arr = arr;
                this.compare = compare || function(a, b) { return a - b }
            }
            getData() {
                //取出最小的
                if(this.size()) {
                    let minValue = this.arr[0], minIndex = 0
                    for(let i = 1; i < this.arr.length; i++) {
                        if(this.compare(this.arr[i], minValue) < 0) {
                            minValue = this.arr[i]
                            minIndex = i;
                        }
                    }
                    this.arr[minIndex] = this.arr[this.size() - 1]
                    this.arr.pop()
                    return minValue
                }
                
            }
            setData(val) {
                this.arr.push(val)
            }
            size() {
                return this.arr.length;
            }
        }



        async function getPath(map, start, end) {
            container.children[start[0] * 50 + start[1]].style.backgroundColor = 'green'
            container.children[end[0] * 50 + end[1]].style.backgroundColor = 'yellow'
            // return 
            let distance = (point) => (point[0] - end[0]) ** 2 + (point[1] - end[1]) ** 2
            // let pointDis = (point1, point2) => (point1[0] - point2[0]) ** 2 + (point1[1] - point2[1]) ** 2
            let queue = new Sorter([start], (a,b) => distance(a) - distance(b))
            let table = Object.create(map)
            table[start[0] * 50 + start[1]] = [null,null, 0]
           const insert = async (x, y, prev) => {
                if(x < 0 || x >= 50 || y < 0 || y >= 50) {
                    return
                }
                let current = table[x*50 + y];
                // console.log(path1, path2)
                if(current === 1) {
                    return 
                }
                let path2 = Math.abs(x + y - (prev[0] + prev[1])) +  table[prev[0] * 50 + prev[1]][2]
                // console.log(current)
                if(current) {
                    let path1 = Math.abs(x + y - (current[0] + current[1])) + current[2]
                    
                    console.log(path1, path2)
                    if(path1 <= path2) {
                        console.log(path1, path2)
                        return;
                    }
                   
                }
                // if(table[x*50 + y]) {
                //     return
                // }
                //每个节点记录前一个结点
                await sleep(100)
                table[x * 50 + y] = [...prev, path2]
                container.children[x * 50 + y].style.backgroundColor = 'lightgreen'
                // container.children[x * 50 + y].innerHTML = prev
                // await sleep(4000)
                queue.setData([x, y])
            }

            while(queue.size()) {
                let [x, y] = queue.getData()
                //找到了
                if(x === end[0] && y === end[1]) {
                    container.children[x * 50 + y].style.backgroundColor = 'red'
                    let result = []
                    while(x !== start[0] || y !== start[1]) {
                        let s1 = map[x * 50 + y];
                        let s2 = table[x * 50 + y]
                        
                        result.push(s1)
                        await sleep(50)
                        x = s2[0]
                        y = s2[1]
                        // console.log(x,y)
                        // await sleep(50)
                        container.children[x * 50 + y].style.backgroundColor = 'blue'
                    }
                    // console.log(result)
                    return result
                }
                await insert(x, y + 1, [x, y])
                await insert(x + 1, y, [x, y])
                await insert(x - 1, y, [x, y])
                
                await insert(x, y - 1, [x, y])
                
                await insert(x + 1, y + 1, [x, y])
                await insert(x + 1, y - 1, [x, y])
                await insert(x - 1, y + 1, [x, y])
                await insert(x - 1, y - 1, [x, y])
                
            }

            return null;
        }
    </script>

</body>

</html>